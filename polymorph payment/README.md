# üí≥ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö ‚Äî PolymorphPayment

## üß± –û–±—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

–¢–∞–±–ª–∏—Ü–∞ **`polymorph_payment`** —Ö—Ä–∞–Ω–∏—Ç **–≤—Å–µ –ø–ª–∞—Ç–µ–∂–∏**, –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–∞.  
–û–Ω–∞ –≤—ã—Å—Ç—É–ø–∞–µ—Ç –∫–∞–∫ —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π —Å–ª–æ–π –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ–ø–ª–∞—Ç (–∫—É—Ä—Å—ã, –∫–ª–∞—Å—Å—ã, –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —Ç.–¥.).

üìÑ **–ú–∏–≥—Ä–∞—Ü–∏–∏:**
- `m241031_221737_create_polymorph_payment_table.php` (—Å—Ç—Ä–æ–∫–∞ 12)  
- `m250709_183539_add_fields_to_polymorph_payment.php` (—Å—Ç—Ä–æ–∫–∞ 12)  
- `m250722_144530_add_columns_polymorph_payment_table.php` (—Å—Ç—Ä–æ–∫–∞ 15)  
- `m250822_145222_add_column_tariff_weeks_in_direction_orders_and_polymorph_payment.php` (—Å—Ç—Ä–æ–∫–∞ 19)  
- `m251009_161558_add_column_deleted_by_polymorph_payment.php` (—Å—Ç—Ä–æ–∫–∞ 12)

### –ö–ª—é—á–µ–≤—ã–µ –ø–æ–ª—è

| –ü–æ–ª–µ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|:---------|:-------------|
| `foreign_class`, `foreign_id` | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏—Å—Ç–æ—á–Ω–∏–∫ |
| `payment_system` | –ù–∞–∑–≤–∞–Ω–∏–µ –ø–ª–∞—Ç—ë–∂–Ω–æ–≥–æ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞ (AlfaBank, YooKassa, PayKeeper, T-Bank, Ozon, Tochka) |
| `external_order_id` | –í–Ω–µ—à–Ω–∏–π ID —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —à–ª—é–∑–∞ |
| `link_id`, `is_demo` | –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —Ñ–ª–∞–≥–∏ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ |
| `buy_month`, `buy_days`, `buy_weeks`, `buy_hours` | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞ |
| `old_date`, `new_date` | –î–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ–¥–ª–µ–Ω–∏–π |
| `deleted_at`, `deleted_by` | Soft-delete –º–µ—Ö–∞–Ω–∏–∫–∞ |

### –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏
- Soft-delete –ø–æ–∑–≤–æ–ª—è–µ—Ç **–æ—Ç–∫–∞—Ç—ã–≤–∞—Ç—å –¥–æ—Å—Ç—É–ø** –±–µ–∑ —Ñ–∏–∑–∏—á–µ—Å–∫–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è.
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **—Ä–∞–∑–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∏** (CRM, –ø–æ–¥–ø–∏—Å–∫–∏, –ø–æ–∫—É–ø–∫–∏ –∏ —Ç.–¥.).

---

## üß© –û—Å–Ω–æ–≤–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ú–æ–¥–µ–ª—å

üìÑ `modules/v1/models/PolymorphPayment.php` (—Å—Ç—Ä–æ–∫–∞ 12)

- –û–ø–∏—Å—ã–≤–∞–µ—Ç —Å–≤—è–∑—å —Å —Ç–∞–±–ª–∏—Ü–µ–π
- –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã –¥–µ–π—Å—Ç–≤–∏–π –∏ –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º
- –†–µ–∞–ª–∏–∑—É–µ—Ç –º–µ—Ç–æ–¥—ã:
  - `generateOrderNumber()`
  - `getPaymentName()`
  - `getPaymentType()`
- –°–æ–¥–µ—Ä–∂–∏—Ç —Å–≤—è–∑–∏ —Å –º–æ–¥–µ–ª—è–º–∏ **Payment** –∏ **User**

---

### –°–µ—Ä–≤–∏—Å

üìÑ `modules/v1/services/PolymorphPaymentService.php`

- **–°—Ç—Ä–æ–∫–∞ 501** ‚Äî —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–ª–∞—Ç–µ–∂–∞ –≤ –Ω—É–∂–Ω–æ–º –ø—Ä–æ–≤–∞–π–¥–µ—Ä–µ
- **–ú–µ—Ç–æ–¥ `processPolymorphPayment()`** (—Å—Ç—Ä–æ–∫–∞ 888)  
  –í—ã–ø–æ–ª–Ω—è–µ—Ç:
  - –∑–∞–ø—Ä–æ—Å —Å—Ç–∞—Ç—É—Å–∞ –≤–æ –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º–µ  
  - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ (–æ–ø–ª–∞—á–µ–Ω / –Ω–µ –æ–ø–ª–∞—á–µ–Ω)  
  - –ø—Ä–æ–¥–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–∞ (`extendDirectionOrder`, `extendClassUser`, `extendBulkOrder`)  
  - –∑–∞–ø—É—Å–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —Å CRM

---

### REST-–∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä

üìÑ `modules/v1/controllers/PolymorphPaymentController.php` (—Å—Ç—Ä–æ–∫–∞ 24)

| –ú–µ—Ç–æ–¥ | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|:--------|:------------|
| `actionBalanceDeposit()` | –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞, —Å–æ–∑–¥–∞–Ω–∏–µ —Å–≤—è–∑–∏ —Å `payment/user_payment` |
| `actionCheckPayment()` | –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Å–µ—Ö –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π |
| `actionRemove()` | Soft-delete + –æ—Ç–∫–∞—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π (–Ω–∞–ø—Ä–∏–º–µ—Ä, –ø–µ—Ä–µ—Å–¥–≤–∏–≥–∞–µ—Ç –¥–∞—Ç—ã —Å–ª–µ–¥—É—é—â–µ–≥–æ –ø–ª–∞—Ç–µ–∂–∞) |

---

### –ö–æ–Ω—Å–æ–ª—å–Ω—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä

üìÑ `commands/PaymentMigrateController.php` (—Å—Ç—Ä–æ–∫–∞ 20)

- –ü–µ—Ä–µ–Ω–æ—Å–∏—Ç —Å—Ç–∞—Ä—ã–µ –∑–∞–ø–∏—Å–∏ –∏–∑ `order_payments` / `payment` –≤ –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É  
- –°–æ–¥–µ—Ä–∂–∏—Ç —Å–µ—Ä–≤–∏—Å–Ω—ã–µ —Ñ–∏–∫—Å—ã: –∫–æ—Ä—Ä–µ–∫—Ç–∏—Ä–æ–≤–∫–∞ –¥–∞—Ç, —Å—É–º–º, —Å—Ç–∞—Ç—É—Å–æ–≤

---

## üí∞ –ü–æ—Ç–æ–∫–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### üßæ –ü–æ–∫—É–ø–∫–∞ –∫—É—Ä—Å–∞ / –∫–ª–∞—Å—Å–∞

–§–æ—Ä–º—ã –∏ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã:
- `modules/v1/models/ClassPaymentForm.php` (—Å—Ç—Ä–æ–∫–∞ 61)
- `modules/v1/models/ClassUserForm.php` (—Å—Ç—Ä–æ–∫–∞ 233)
- `modules/v1/models/ChildrenForm.php` (—Å—Ç—Ä–æ–∫–∞ 435)
- `modules/v1/controllers/ClassesController.php` (—Å—Ç—Ä–æ–∫–∞ 978)
- `modules/v1/controllers/DirectionOrdersController.php` (—Å—Ç—Ä–æ–∫–∞ 1622)

–í—ã–∑—ã–≤–∞—é—Ç:
```php
PolymorphPaymentService::createPolymorphPayment();
PolymorphPaymentService::processPolymorphPayment();
```
(–¥–ª—è CRM- –∏–ª–∏ –±–µ—Å–ø–ª–∞—Ç–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤)

---

### üïì –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π

üìÑ `modules/v1/controllers/DirectionOrdersController.php` (—Å—Ç—Ä–æ–∫–∞ 1262)

SQL-–∑–∞–ø—Ä–æ—Å –æ–±—ä–µ–¥–∏–Ω—è–µ—Ç:
`polymorph_payment + class_user + direction_orders + timetable_report`  
–¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –æ–ø–ª–∞—Ç –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ.

---

### üìà –û—Ç—á—ë—Ç—ã –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

üìÑ `modules/v1/controllers/DirectionOrdersController.php`
- (—Å—Ç—Ä–æ–∫–∞ 2305)
- (—Å—Ç—Ä–æ–∫–∞ 2391)
- (—Å—Ç—Ä–æ–∫–∞ 2561)

–û—Ç—á—ë—Ç—ã `reportParents` / `reportSop` –∏—Å–ø–æ–ª—å–∑—É—é—Ç –∞–≥—Ä–µ–≥–∞—Ç—ã –ø–æ `polymorph_payment`.

---

### ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞

–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö —Å–∏—Å—Ç–µ–º –±–µ—Ä—É—Ç—Å—è –∏–∑ **`settings`**  
(—á–µ—Ä–µ–∑ `Setting::find()` –≤–Ω—É—Ç—Ä–∏ `PolymorphPaymentService`).

–≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç **–ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞** (YooKassa, PayKeeper, T-Bank, Alfa, Ozon, Tochka)  
–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∫–æ–¥–∞.

---

## ‚è±Ô∏è –§–æ–Ω–æ–≤–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### Cron-–ø—Ä–æ—Ü–µ—Å—Å

üìÑ `commands/CronController.php` (—Å—Ç—Ä–æ–∫–∞ 316)

- –ö–∞–∂–¥—ã–µ N –º–∏–Ω—É—Ç –≤—ã–±–∏—Ä–∞–µ—Ç –¥–æ **1000 –Ω–µ–∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π**
- –ü–µ—Ä–µ–¥–∞—ë—Ç –∏—Ö –≤ `processPolymorphPayment()` –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–æ–≤

---

### –°–≤—è–∑–∫–∞ —Å CRM

`PolymorphPaymentService`:
- –æ–±–Ω–æ–≤–ª—è–µ—Ç `CrmLeadPaymentLink`
- –æ–±–Ω–æ–≤–ª—è–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –ª–∏–¥–∞
- –ø—É—à–∏—Ç `TriggerNotificationJob` –¥–ª—è —Å–æ–±—ã—Ç–∏–π:
  - `payment_completed`
  - `new_purchase`

---

### üíµ –ë–∞–ª–∞–Ω—Å –∏ –æ—Ç–∫–∞—Ç—ã

- –ü–æ–ª—è `use_balance`, `balance_action` –ø–æ–∑–≤–æ–ª—è—é—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É –¥–ª—è **–ø–æ–ø–æ–ª–Ω–µ–Ω–∏–π –∏ —Å–ø–∏—Å–∞–Ω–∏–π**
- –õ–æ–≥–∏–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–∞–ª–∞–Ω—Å–∞ –≤—Å—Ç—Ä–æ–µ–Ω–∞ –≤ `processPolymorphPayment()`
- –£–¥–∞–ª–µ–Ω–∏–µ / –æ—Ç–∫–∞—Ç (`PolymorphPaymentController::actionRemove`)  
  –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –¥–∞—Ç—ã –ø–æ–¥–ø–∏—Å–∫–∏ –∏ –≤—ã–∑—ã–≤–∞–µ—Ç `rollbackBulkOrder` –¥–ª—è —Å–æ–≥–ª–∞—Å–æ–≤–∞–Ω–Ω–æ—Å—Ç–∏ –¥–∞–Ω–Ω—ã—Ö

---

## üßæ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø–∏—Å–µ–π –≤—Ä—É—á–Ω—É—é

–î–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å SQL:

```sql
SELECT * FROM polymorph_payment WHERE status = 0;
```

–î–ª—è —Ä—É—á–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è / —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏:
```bash
yii cron/check-polymorph-payments
```

---

## üìò –†–µ–∑—é–º–µ

- `polymorph_payment` ‚Äî —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –¥–ª—è **–≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –æ–ø–ª–∞—Ç**
- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç **soft-delete**, **CRM-–∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é**, **–≥–µ–π–º–∏—Ñ–∏–∫–∞—Ü–∏—é** –∏ **–±–∞–ª–∞–Ω—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏**
- –†–∞–±–æ—Ç–∞–µ—Ç —Å –Ω–µ—Å–∫–æ–ª—å–∫–∏–º–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–∞–º–∏ –∏ –ø–æ–∑–≤–æ–ª—è–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ —É–ø—Ä–∞–≤–ª—è—Ç—å —Å—Ç–∞—Ç—É—Å–∞–º–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π
