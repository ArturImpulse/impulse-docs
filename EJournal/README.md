# Электронный журнал v2 (JournalBetaController)

Этот документ описывает работу электронного журнала версии 2, реализованного в `JournalBetaController.php`.
Журнал используется для просмотра посещаемости и успеваемости учащихся, а также для выгрузки отчётов в формате Excel.

## Общая архитектура и данные

Основные сущности и таблицы:

- `direction_orders` — заказы/записи учащихся на направления, группы, классы.
- `timetable_report` — отчёты по занятиям (строки журнала: даты, уроки, доп. столбцы).
- `journal_timetable` — статусы посещения по каждому занятию и учащемуся.
- `journal_grades` — оценки по занятиям.
- `user` — данные пользователей (ФИО и др.).
- `additional_field` / `additional_fields_data` — пользовательские доп. поля по учащимся.

Авторизация — через JWT Bearer. Для всех списков используется сериализатор Yii2 с `collectionEnvelope = "data"`.

По умолчанию пагинация для журнала — `perPage = 2000`.

---

## 1. Общая логика работы журнала

### 1.1. Фильтрация и выбор учащихся

**Эндпоинт:** `GET /v1/journal-beta/general-journal`

Входные параметры:

- `start_date` — дата начала периода (включительно).
- `end_date` — дата конца периода (включительно, дополнительно обрезается по «сегодня»).
- `groups[]` — массив ID групп, по которым строится журнал.
- `type` — тип журнала/отчёта (строка, зависит от бизнес-логики).
- `page` — номер страницы (пагинация).
- `sort_field` — поле сортировки учащихся (по умолчанию ФИО).
- `sort_asc` — направление сортировки (`1` — по возрастанию, `0` — по убыванию).

Как выбираются дети:

1. Берутся все заказы из `direction_orders` по выбранным `groups[]`.
2. Из выборки исключаются пользователи со статусами, отличными от `0` и `10` (любой статус ≠0/10 — игнорируется).
3. Для каждого заказа определяется флаг `is_disabled`:
   - статус заказа `0` → ребёнок считается **отключённым** (disabled) в рамках журнала;
   - остальные валидные статусы (например, `10`) → активный ребёнок.

### 1.2. Выбор отчётов по занятиям

Далее строится запрос к `timetable_report` с присоединением:

- `journal_timetable` (по статусам посещения и комментариям),
- `journal_grades` (по оценкам),
- `user` (ФИО преподавателя/доп. данные),
- при необходимости других таблиц (через ActiveRecord и `joinWith`).

Фильтрация отчётов:

- по датам (`start_date`, `end_date` с обрезкой по текущей дате),
- по статусу занятия: `status <= 5`,
- по группам — через `JSON_CONTAINS(tr.groups, ...)` (поле `groups` хранит JSON со списком ID групп).

Сортировка отчётных строк:

- по дате занятия (`date_conference`) и/или
- по именам (в зависимости от выбранного режима).

### 1.3. Формирование ответа `general-journal`

Контроллер формирует две основные структуры:

1. **`dates`** — список строк журнала (занятий):
   - `id` — идентификатор записи `timetable_report`,
   - `date` — дата занятия,
   - `groups` / `groupsText` — список групп и их названия (опционально),
   - `pinned` — флаг закрепления колонки,
   - `lesson_topic` — тема урока,
   - `comment_to_dz` — комментарий к домашнему заданию,
   - `is_additional` — признак доп. колонки (`1` — колонка добавлена вручную через `actionAddColumn`),
   - `comment` — общий комментарий по занятию.

2. **`children`** — список учащихся. Для каждого ребёнка строится карта по `reportId`:
   - статус посещения (`jt_status`),
   - комментарий к посещению/уроку,
   - оценки из `journal_grades` (поля `grade`, `weight`, `comment`),
   - уникальные ДЗ / результаты работ `unique_hw_*` (проценты, оценки и др.).

Дополнительно в ответ добавляются:

- `_meta` — информация о пагинации (`totalCount`, `pageCount`, `currentPage`, `perPage = 2000`),
- `_links` — ссылки `self`, `first`, `last`, `prev`, `next`.

Сортировка детей по умолчанию — по ФИО (с учётом `sort_field` и `sort_asc`).

---

## 2. Выгрузка журнала в Excel

**Эндпоинт:** `GET /v1/journal-beta/general-journal-export`

Этот эндпоинт использует те же параметры фильтрации, что и `general-journal`, и дополнительный параметр:

- `download_summary`:
  - `0` — обычная выгрузка журнала по датам (по умолчанию);
  - `1` — сводка по учащимся с доп. полями.

Дополнительные параметры:

- `is_all_children` (булево):
  - `true` — включать в выгрузку **всех** детей, в том числе отключённых;
  - `false` — исключать отключённых детей из выгрузки.

Если после фильтрации данных нет, контроллер возвращает `404`.

### 2.1. Обычная выгрузка (download_summary = 0)

Формат Excel-файла:

Базовые колонки:

1. `№` — порядковый номер строки.
2. `ФИО` — полное имя учащегося.
3. `Пропуски` — количество пропущенных занятий (по статусам Н / П- и т.п.).
4. `Посещения` — количество посещённых занятий.
5. `Посещаемость` — процент посещения (расчёт по статусам посещаемости).
6. `Ср. балл` — средний балл по оценкам (по `journal_grades`).

Далее добавляются столбцы по датам занятий:
- каждая дата в формате `d.m.Y`,
- в ячейке отражается комбинация:
  - статус посещения (`П+`, `П`, `П-`, `Н`),
  - и/или оценка (либо просто статус «П», либо конкретная оценка, если она выставлена).

Визуальное оформление:

- статусы посещения подсвечиваются цветом (логика цветовой схемы задаётся в классе экспорта),
- отключённые дети (`is_disabled = true`) при `is_all_children = 1` — строка заливается серым фоном.

### 2.2. Сводка (download_summary = 1)

Формат Excel-файла:

Базовые колонки (в начале таблицы):

1. `Курс`
2. `Группа`
3. `Класс`
4. `ФИО учащегося`
5. `Пропуски`
6. `Посещения`
7. `Посещаемость %`
8. `Средний балл`

Значения `Курс`/`Группа`/`Класс` подтягиваются из заказов ребёнка (`direction_orders` — поля направления, группы и классы). Метрики по посещаемости и среднему баллу считаются так же, как в обычной выгрузке, но без поколоночного вывода дат.

#### 2.2.1. Динамические столбцы из timetable_report

После базовых колонок добавляются **динамические** колонки на основе полей таблицы `timetable_report`.

Из схемы таблицы выбираются все поля, кроме «базовых», которые не попадают в сводку:

Исключаемые поля (`НЕ попадают` в сводку):

- `id`
- `event_id`
- `duration`
- `status`
- `link_to_meeting`
- `link_to_meeting_for_children`
- `start_time`
- `end_time`
- `title`
- `attendees`
- `groups`
- `groupsText`
- `attendeesText`
- `seminarians`
- `seminariansNames`
- `date_conference`
- `audienceNumber`
- `lesson_topic`
- `comment`
- `comment_to_dz`
- `pinned`
- `is_offline`
- `in_recording`
- `speaker_id`
- `is_additional`
- `show_to_child`
- `created_at`
- `updated_at`
- `opened_at`

Все **остальные** поля `timetable_report` считаются динамическими и добавляются в конец каждой строки сводки.

Логика получения значений:

- для выбранного набора фильтров (даты, группы, типы) находится **последняя** запись `timetable_report`,
- значения динамических полей берутся из этой последней записи,
- одни и те же значения ставятся во все строки сводки (одинаковый контекст периода).

#### 2.2.2. Пользовательские доп. поля (additional_field)

Доп. поля бывают двух типов:

1. **Профильные поля** (`is_profile_field = 1`):
   - хранится ссылка на поле профиля (`field_name`),
   - значение берётся из профиля пользователя.

2. **Поля с отдельным хранением**:
   - значения хранятся в `additional_fields_data`,
   - могут быть строковыми, числовыми и т.д.

Во время формирования сводки (`download_summary = 1`) все описанные в `additional_field` поля добавляются в **конец строки** Excel-файла, после динамических полей `timetable_report`.

Итоговый порядок колонок в сводке:

1. Базовые поля (Курс/Группа/Класс/ФИО/Пропуски/Посещения/Посещаемость %/Средний балл).
2. Динамические поля из `timetable_report` (все, кроме списка базовых выше).
3. Доп. поля из `additional_field`/`additional_fields_data` и профильных полей.

Сортировка в сводке **не применяется**: строки идут в том порядке, в котором дети возвращены из `general-journal`.

---

## 3. Дополнительные эндпоинты и операции

### 3.1. Управление доп. колонками журнала

**Добавление доп. колонки**

- Метод контроллера: `actionAddColumn`
- Назначение: создать дополнительную колонку в журнале (строку `timetable_report` с `is_additional = 1`).

При добавлении указываются:

- дата колонки,
- `comment` — заголовок/описание колонки,
- `groups` — список групп,
- `attendees` — участники,
- `show_to_child` — видимость для учащихся.

**Удаление доп. колонки**

- Метод контроллера: `actionDeleteColumn`
- Назначение: удалить только дополнительную колонку (`is_additional = 1`).

Базовые колонки (события расписания) удаления через этот метод не подлежат.

### 3.2. Закрепление колонки

**Закрепление/открепление колонки**

- Метод контроллера: `actionPinColumn`
- Назначение: изменить флаг `pinned` у записи `timetable_report`.

Позволяет закреплять важные колонки (например, последнюю контрольную работу) в начале журнала.

### 3.3. Отчёты по ученику и направлениям

**Список отчётов ученика по направлению**

- Метод контроллера: `actionStudentReportsByDirection`
- Назначение: получить список отчётов по конкретному направлению для выбранного ученика.

Доступ контролируется по группам/участникам (`groups`/`attendees`).

### 3.4. Дополнительные поля (additional_field)

Методы CRUD для управления доп. полями:

- `actionAddField` — создание нового поля.
- `actionGetAdditionalFields` — получение списка полей.
- `actionEditAdditionalField` — редактирование существующего поля.
- `actionDeleteAdditionalField` — удаление поля.

Поля могут быть:

- привязаны к профилю (`is_profile_field = 1`, чтение из профиля по `field_name`);
- с отдельным хранилищем значений (`additional_fields_data`).

Все созданные поля автоматически участвуют в сводке (`download_summary = 1`) и добавляются в конец строки, после базовых и динамических колонок.

---

## 4. Отличия между видами выгрузок

Краткое сравнение режимов `general-journal-export`:

### 4.1. Обычная выгрузка (`download_summary = 0`)

- Фокус на **поурочном** отображении данных.
- Включает **даты занятий**, статусы посещения и оценки по каждому занятию.
- Нет дополнительных динамических колонок из `timetable_report`.
- Нет доп. пользовательских полей из `additional_field`.
- Используется для анализа активности по датам (календарный вид журнала).

### 4.2. Сводка (`download_summary = 1`)

- Фокус на **сводных показателях по учащемуся** за период.
- Базовые поля: Курс/Группа/Класс, ФИО, пропуски, посещения, посещаемость %, средний балл.
- Добавляются динамические поля из `timetable_report` (кроме базовых служебных).
- Добавляются все пользовательские доп. поля (`additional_field`, профильные поля).
- Используется для административной/управленческой отчётности, передачи данных в сторонние системы, аналитики и т.п.

---

## 5. Примеры запросов

### 5.1. Получение журнала по группе за месяц

```http
GET /v1/journal-beta/general-journal?start_date=2025-09-01&end_date=2025-09-30&groups[]=123&type=default&page=1&sort_field=name&sort_asc=1
Authorization: Bearer <JWT>
Accept: application/json
```

Ответ (упрощённый пример структуры):

```json
{
  "data": {
    "dates": [
      {
        "id": 1001,
        "date": "2025-09-01",
        "pinned": 0,
        "lesson_topic": "Тема занятия",
        "comment_to_dz": "Сделать упражнение ...",
        "is_additional": 0,
        "comment": "Комментарий преподавателя"
      }
    ],
    "children": [
      {
        "id": 501,
        "full_name": "Иванов Иван Иванович",
        "is_disabled": false,
        "reports": {
          "1001": {
            "status": "П+",
            "comment": "Присутствовал, работал активно",
            "grade": 5,
            "weight": 1,
            "grade_comment": ""
          }
        },
        "unique_hw": {
          "hw_1": {
            "percent": 90,
            "grade": 5
          }
        }
      }
    ]
  },
  "_meta": {
    "totalCount": 10,
    "pageCount": 1,
    "currentPage": 1,
    "perPage": 2000
  },
  "_links": {
    "self": { "href": "..." },
    "first": { "href": "..." },
    "last": { "href": "..." }
  }
}
```

### 5.2. Выгрузка сводки по той же группе

```http
GET /v1/journal-beta/general-journal-export?start_date=2025-09-01&end_date=2025-09-30&groups[]=123&download_summary=1&is_all_children=1
Authorization: Bearer <JWT>
Accept: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
```

Ответ: бинарный Excel-файл со сводкой по учащимся и доп. колонками.

---

## 6. Известные ограничения и особенности

- Максимальный размер страницы журнала — 2000 учащихся (`perPage=2000`). При большем количестве необходимо переходить на следующую страницу.
- При формировании сводки (`download_summary = 1`) динамические поля из `timetable_report` берутся **по последней записи** в выбранном диапазоне для переданных фильтров и далее повторяются для всех строк.
- Отключённые дети учитываются в отчётах только при `is_all_children = 1`; в обычной выгрузке они визуально подсвечиваются серым.
- Логика расчёта посещаемости и среднего балла едина для всех выгрузок и основана на статусах `journal_timetable` и оценках `journal_grades`.

Этот README предназначен как базовая документация для разработчиков и аналитиков, работающих с электронным журналом v2 (`JournalBetaController`). При изменении структуры таблиц или бизнес-логики необходимо обновлять соответствующие разделы документа.
